---
title: ThreadLocal
icon: laptop-code
category:
  - ã€Šé¢è¯•1v1ã€‹
---



**æˆ‘æ˜¯ javapubï¼Œä¸€å `Markdown` ç¨‹åºå‘˜ä»ğŸ‘¨â€ğŸ’»ï¼Œå…«è‚¡æ–‡ç§å­é€‰æ‰‹ã€‚**



**<font color=blue>é¢è¯•å®˜</font>ï¼š ä½ å¥½ï¼Œè¯·é—®ä½ å¯¹ ThreadLocal æœ‰äº†è§£å—ï¼Ÿ**

**<font color=red>å€™é€‰äººï¼š</font>** æ‚¨å¥½ï¼Œæˆ‘çŸ¥é“ ThreadLocal æ˜¯ä¸€ä¸ª Java ä¸­çš„ç±»ï¼Œå®ƒå¯ä»¥è®©æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„å˜é‡å‰¯æœ¬ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

**<font color=blue>é¢è¯•å®˜</font>ï¼š éå¸¸å¥½ï¼Œé‚£ä½ èƒ½å¦è¯¦ç»†ä»‹ç»ä¸€ä¸‹ ThreadLocal çš„ä½¿ç”¨æ–¹æ³•ï¼Ÿ**

**<font color=red>å€™é€‰äººï¼š</font>** å½“ç„¶å¯ä»¥ã€‚ThreadLocal çš„ä½¿ç”¨æ–¹æ³•éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒçš„ set æ–¹æ³•æ¥è®¾ç½®å½“å‰çº¿ç¨‹çš„å˜é‡å€¼ï¼Œè°ƒç”¨ get æ–¹æ³•æ¥è·å–å½“å‰çº¿ç¨‹çš„å˜é‡å€¼å³å¯ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ä»£ç ï¼š

```java
public class ThreadLocalDemo {
    private static final ThreadLocal<String> threadLocal = new ThreadLocal<>();

    public static void main(String[] args) {
        Thread thread1 = new Thread(() -> {
            threadLocal.set("Hello from thread1");
            System.out.println(threadLocal.get());
        });

        Thread thread2 = new Thread(() -> {
            threadLocal.set("Hello from thread2");
            System.out.println(threadLocal.get());
        });

        thread1.start();
        thread2.start();
    }
}
```

è¿™ä¸ªç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª ThreadLocal å¯¹è±¡ï¼Œå¹¶åœ¨ä¸¤ä¸ªçº¿ç¨‹ä¸­åˆ†åˆ«è®¾ç½®äº†ä¸åŒçš„å˜é‡å€¼ã€‚ç”±äºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å˜é‡å‰¯æœ¬ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªçº¿ç¨‹äº’ä¸å¹²æ‰°ï¼Œè¾“å‡ºçš„ç»“æœä¹Ÿæ˜¯ä¸åŒçš„ã€‚

**<font color=blue>é¢è¯•å®˜</font>ï¼š éå¸¸å¥½ï¼Œé‚£ä½ èƒ½å¦è§£é‡Šä¸€ä¸‹ ThreadLocal çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ**

**<font color=red>å€™é€‰äººï¼š</font>** å½“ç„¶å¯ä»¥ã€‚ThreadLocal çš„åŸç†å…¶å®å¾ˆç®€å•ï¼Œå®ƒæ˜¯é€šè¿‡ä¸€ä¸ª ThreadLocalMap å¯¹è±¡æ¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„å˜é‡å‰¯æœ¬çš„ã€‚å½“æˆ‘ä»¬è°ƒç”¨ ThreadLocal çš„ set æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡ä¸­å­˜å‚¨äº†ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå…¶ä¸­é”®æ˜¯å½“å‰ ThreadLocal å¯¹è±¡ï¼Œå€¼æ˜¯æˆ‘ä»¬è®¾ç½®çš„å˜é‡å€¼ã€‚å½“æˆ‘ä»¬è°ƒç”¨ ThreadLocal çš„ get æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡ä¸­æŸ¥æ‰¾å½“å‰ ThreadLocal å¯¹è±¡å¯¹åº”çš„å˜é‡å€¼ã€‚

ä¸‹é¢æ˜¯ ThreadLocalMap çš„æºç å®ç°ï¼Œæˆ‘åœ¨ä»£ç ä¸­åŠ äº†æ³¨é‡Šï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©æ‚¨æ›´å¥½åœ°ç†è§£ï¼š

```java
class ThreadLocalMap {
    static class Entry extends WeakReference<ThreadLocal<?>> {
        Object value;

        Entry(ThreadLocal<?> k, Object v) {
            super(k);
            value = v;
        }
    }

    // åˆå§‹å®¹é‡ä¸º 16
    private static final int INITIAL_CAPACITY = 16;

    // æ‰©å®¹å› å­ä¸º 2
    private static final float LOAD_FACTOR = 0.75f;

    // å­˜å‚¨é”®å€¼å¯¹çš„æ•°ç»„
    private Entry[] table;

    // æ•°ç»„ä¸­é”®å€¼å¯¹çš„æ•°é‡
    private int size = 0;

    // ä¸‹ä¸€ä¸ªè¦æ¸…ç†çš„é”®å€¼å¯¹çš„ç´¢å¼•
    private int threshold;

    // æ¸…ç†é”®å€¼å¯¹çš„é˜ˆå€¼
    private void setThreshold(int len) {
        threshold = (int) (len * LOAD_FACTOR);
    }

    // è·å–é”®å€¼å¯¹çš„å€¼
    private Object getEntry(ThreadLocal<?> key) {
        int i = key.threadLocalHashCode & (table.length - 1);
        Entry e = table[i];
        if (e != null && e.get() == key) {
            return e.value;
        } else {
            return null;
        }
    }

    // è®¾ç½®é”®å€¼å¯¹çš„å€¼
    private void setEntry(ThreadLocal<?> key, Object value) {
        // æ¸…ç†é”®å€¼å¯¹
        expungeStaleEntries();

        // è®¡ç®—é”®å€¼å¯¹çš„ç´¢å¼•
        int i = key.threadLocalHashCode & (table.length - 1);

        // å¦‚æœè¯¥ä½ç½®å·²ç»æœ‰é”®å€¼å¯¹äº†ï¼Œåˆ™å¾€åæŸ¥æ‰¾ç©ºä½ç½®
        for (Entry e = table[i]; e != null; e = table[i = nextIndex(i, table.length)]) {
            ThreadLocal<?> k = e.get();

            // å¦‚æœæ‰¾åˆ°äº†ç›¸åŒçš„ ThreadLocal å¯¹è±¡ï¼Œåˆ™ç›´æ¥æ›¿æ¢å€¼
            if (k == key) {
                e.value = value;
                return;
            }

            // å¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªç©ºçš„ä½ç½®ï¼Œåˆ™æ’å…¥æ–°çš„é”®å€¼å¯¹
            if (k == null) {
                replaceStaleEntry(key, value, i);
                return;
            }
        }

        // å¦‚æœè¯¥ä½ç½®æ²¡æœ‰é”®å€¼å¯¹ï¼Œåˆ™æ’å…¥æ–°çš„é”®å€¼å¯¹
        table[i] = new Entry(key, value);
        int sz = ++size;
        if (sz >= threshold) {
            // æ‰©å®¹
            rehash();
        }
    }

    // æ¸…ç†è¿‡æœŸçš„é”®å€¼å¯¹
    private void expungeStaleEntries() {
        Entry[] tab = table;
        int len = tab.length;
        for (int i = 0; i < len; i++) {
            Entry e = tab[i];
            if (e != null && e.get() == null) {
                // æ¸…ç†è¿‡æœŸçš„é”®å€¼å¯¹
                expungeStaleEntry(i);
            }
        }
    }

    // æ¸…ç†æŒ‡å®šä½ç½®çš„é”®å€¼å¯¹
    private void expungeStaleEntry(int staleSlot) {
        Entry[] tab = table;
        int len = tab.length;

        // æ¸…ç†æŒ‡å®šä½ç½®çš„é”®å€¼å¯¹
        tab[staleSlot].value = null;
        tab[staleSlot] = null;
        size--;

        // é‡æ–°æ•£åˆ—è¯¥ä½ç½®ä¹‹åçš„é”®å€¼å¯¹
        Entry e;
        int i;
        for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {
            ThreadLocal<?> k = e.get();
            if (k == null) {
                e.value = null;
                tab[i] = null;
                size--;
            } else {
                int h = k.threadLocalHashCode & (len - 1);
                if (h != i) {
                    tab[i] = null;

                    // å¾€åæŸ¥æ‰¾ç©ºä½ç½®
                    while (tab[h] != null) {
                        h = nextIndex(h, len);
                    }

                    // æ’å…¥é”®å€¼å¯¹
                    tab[h] = e;
                }
            }
        }
    }

    // æ‰©å®¹
    private void rehash() {
        expungeStaleEntries();

        // å¦‚æœå½“å‰æ•°ç»„é•¿åº¦å·²ç»è¾¾åˆ°æœ€å¤§å€¼ï¼Œåˆ™ä¸å†æ‰©å®¹
        if (size >= threshold - threshold / 4) {
            return;
        }

        int newCapacity = table.length * 2;
        Entry[] newTable = new Entry[newCapacity];
        int count = 0;

        for (Entry e : table) {
            if (e != null) {
                ThreadLocal<?> k = e.get();
                if (k == null) {
                    e.value = null;
                } else {
                    int i = k.threadLocalHashCode & (newCapacity - 1);
                    while (newTable[i] != null) {
                        i = nextIndex(i, newCapacity);
                    }
                    newTable[i] = e;
                    count++;
                }
            }
        }

        setThreshold(newCapacity);
        size = count;
        table = newTable;
    }

    // è®¡ç®—ä¸‹ä¸€ä¸ªç´¢å¼•
    private static int nextIndex(int i, int len) {
        return (i + 1) % len;
    }
}
```

**<font color=blue>é¢è¯•å®˜</font>ï¼š éå¸¸å¥½ï¼Œé‚£ä½ èƒ½å¦è§£é‡Šä¸€ä¸‹ ThreadLocal çš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ**

**<font color=red>å€™é€‰äººï¼š</font>** å½“ç„¶å¯ä»¥ã€‚ThreadLocal çš„ä¼˜ç‚¹æ˜¯å®ƒå¯ä»¥è®©æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„å˜é‡å‰¯æœ¬ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å¦å¤–ï¼ŒThreadLocal çš„ä½¿ç”¨æ–¹æ³•éå¸¸ç®€å•ï¼Œåªéœ€è¦è°ƒç”¨ set å’Œ get æ–¹æ³•å³å¯ã€‚

ThreadLocal çš„ç¼ºç‚¹æ˜¯å®ƒå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼é—®é¢˜ã€‚ç”±äºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å˜é‡å‰¯æœ¬ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰åŠæ—¶æ¸…ç†è¿™äº›å˜é‡å‰¯æœ¬ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚å¦å¤–ï¼ŒThreadLocal çš„ä½¿ç”¨ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€å¢åŠ ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦ç»´æŠ¤è‡ªå·±çš„å˜é‡å‰¯æœ¬ã€‚

**<font color=blue>é¢è¯•å®˜</font>ï¼š éå¸¸å¥½ï¼Œä½ å¯¹ ThreadLocal çš„äº†è§£éå¸¸æ·±å…¥ï¼Œä»Šå¤©å°±åˆ°è¿™é‡Œå§ã€‚**

**<font color=red>å€™é€‰äººï¼š</font>** è°¢è°¢æ‚¨çš„æé—®ï¼Œæˆ‘å¾ˆé«˜å…´èƒ½å¤Ÿåˆ†äº«æˆ‘çš„çŸ¥è¯†ã€‚





![](https://ghproxy.com/https://raw.githubusercontent.com/Rodert/javapub_oss/main/other/12.jpg?raw=true)


æœ€è¿‘æˆ‘åœ¨æ›´æ–°ã€Šé¢è¯•1v1ã€‹ç³»åˆ—æ–‡ç« ï¼Œä¸»è¦ä»¥åœºæ™¯åŒ–çš„æ–¹å¼ï¼Œè®²è§£æˆ‘ä»¬åœ¨é¢è¯•ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œè‡´åŠ›äºè®©æ¯ä¸€ä½å·¥ç¨‹å¸ˆæ‹¿åˆ°è‡ªå·±å¿ƒä»ªçš„offerï¼Œæ„Ÿå…´è¶£å¯ä»¥å…³æ³¨**å…¬ä¼—å·JavaPub**è¿½æ›´ï¼


![](https://javapub-common-oss.oss-cn-beijing.aliyuncs.com/javapub/2024%2F06%2F06%2F20240606-225632.png)


ğŸç›®å½•åˆé›†ï¼š

Giteeï¼š`https://gitee.com/rodert/JavaPub`

GitHubï¼š`https://github.com/Rodert/JavaPub`


<http://javapub.net.cn>
