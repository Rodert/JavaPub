import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,o as a,e as n}from"./app-B-HJLt48.js";const l={},e=n(`<p>这篇文章源于，如果 nginx timewait 过多怎么办？本文将从应用角度出发，穿插TCP原理，详细讲解Nginx的TCP相关知识。</p><h2 id="_1-什么是tcp" tabindex="-1"><a class="header-anchor" href="#_1-什么是tcp"><span>1. 什么是TCP</span></a></h2><p>TCP（传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。在网络模型中，TCP位于传输层，主要负责在不可靠的网络环境中提供可靠的数据传输服务。</p><p>TCP的主要特点：</p><ul><li><strong>面向连接</strong>：通信前需要先建立连接（三次握手），通信结束后需要释放连接（四次挥手）</li><li><strong>可靠性</strong>：通过序列号、确认应答、重传等机制保证数据可靠传输</li><li><strong>流量控制</strong>：通过滑动窗口机制控制数据传输速率</li><li><strong>拥塞控制</strong>：通过各种算法（如慢启动、拥塞避免）防止网络拥塞</li></ul><h2 id="_2-nginx对tcp的支持" tabindex="-1"><a class="header-anchor" href="#_2-nginx对tcp的支持"><span>2. Nginx对TCP的支持</span></a></h2><p>Nginx最初设计用于HTTP服务，但从1.9.0版本开始，Nginx加入了对TCP和UDP的支持，这一功能被称为<code>stream</code>模块。这使得Nginx能够作为各种TCP服务的反向代理和负载均衡器，如：</p><ul><li>MySQL/PostgreSQL等数据库</li><li>Redis/Memcached等缓存服务</li><li>SMTP/POP3/IMAP等邮件服务</li><li>其他自定义TCP协议服务</li></ul><h3 id="_2-1-nginx-stream模块的基本工作原理" tabindex="-1"><a class="header-anchor" href="#_2-1-nginx-stream模块的基本工作原理"><span>2.1 Nginx Stream模块的基本工作原理</span></a></h3><p>Nginx处理TCP连接的流程：</p><ol><li>客户端发起TCP连接请求到Nginx</li><li>Nginx接受连接并根据配置决定如何处理</li><li>Nginx将连接代理到上游服务器，并在两者之间转发数据</li><li>连接结束后，Nginx关闭与客户端和上游服务器的连接</li></ol><h2 id="_3-nginx-tcp代理的配置" tabindex="-1"><a class="header-anchor" href="#_3-nginx-tcp代理的配置"><span>3. Nginx TCP代理的配置</span></a></h2><h3 id="_3-1-基本配置" tabindex="-1"><a class="header-anchor" href="#_3-1-基本配置"><span>3.1 基本配置</span></a></h3><p>要使用Nginx的TCP功能，首先需要确保编译时包含了stream模块。如果是使用预编译的二进制包，一般已经包含该模块。</p><p>基本的TCP代理配置如下：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 在http上下文之外配置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 定义上游服务器组</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> mysql_servers </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.1:3306 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">weight</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        server 192.168.1.2:3306 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">weight</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 监听3306端口并代理到上游服务器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    server {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3306</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">mysql_servers;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-负载均衡策略" tabindex="-1"><a class="header-anchor" href="#_3-2-负载均衡策略"><span>3.2 负载均衡策略</span></a></h3><p>Nginx的TCP负载均衡支持多种策略：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 1. 轮询（默认）：每个请求按时间顺序轮流分配到不同服务器</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> tcp_servers1 </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.1:3306;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.2:3306;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 2. 权重：按权重比例分配</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> tcp_servers2 </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.1:3306 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">weight</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        server 192.168.1.2:3306 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">weight</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 3. 最少连接：将请求发送到活动连接数最少的服务器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    upstream tcp_servers3 {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        least_conn;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.1:3306;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.2:3306;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 4. 哈希：根据指定的键值的哈希结果分配</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> tcp_servers4 </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        hash </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">remote_addr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> consistent;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.1:3306;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.2:3306;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-高级配置选项" tabindex="-1"><a class="header-anchor" href="#_3-3-高级配置选项"><span>3.3 高级配置选项</span></a></h3><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> backend </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.1:3306;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.2:3306;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3306</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 代理超时设置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 连接上游服务器超时时间</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10m</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;         </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 两次成功读/写操作之间的超时时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 上游服务器健康检查</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        health_check </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">interval=5 passes=2 fails=3;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 访问日志</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        access_log </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/var/log/nginx/tcp.access.log;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 代理到上游服务器</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">backend;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-nginx-tcp优化" tabindex="-1"><a class="header-anchor" href="#_4-nginx-tcp优化"><span>4. Nginx TCP优化</span></a></h2><h3 id="_4-1-内核参数优化" tabindex="-1"><a class="header-anchor" href="#_4-1-内核参数优化"><span>4.1 内核参数优化</span></a></h3><p>为了优化TCP连接处理，可以调整以下Linux内核参数：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 修改/etc/sysctl.conf文件</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 增加最大打开文件描述符数量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">fs.file-max</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1000000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 增加本地端口范围</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">net.ipv4.ip_local_port_range</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1024</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 65000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># TCP连接复用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">net.ipv4.tcp_tw_reuse</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># TIME_WAIT状态sock的最大数量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">net.ipv4.tcp_max_tw_buckets</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 6000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># TCP Keepalive参数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">net.ipv4.tcp_keepalive_time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 600</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">net.ipv4.tcp_keepalive_intvl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 60</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">net.ipv4.tcp_keepalive_probes</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 应用更改</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sysctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -p</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-nginx工作进程和连接优化" tabindex="-1"><a class="header-anchor" href="#_4-2-nginx工作进程和连接优化"><span>4.2 Nginx工作进程和连接优化</span></a></h3><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 主配置文件中的全局设置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">worker_processes </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">auto;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 自动设置为CPU核心数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">worker_rlimit_nofile </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">65535</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 每个进程可打开的最大文件描述符数量</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">events</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    worker_connections </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">65535</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 每个工作进程的最大连接数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    multi_accept </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;           </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 一次接受所有新连接</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    use </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">epoll</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;                 </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 使用高效的epoll事件模型（Linux系统）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # TCP超时设置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    proxy_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">300s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-time-wait状态与解决方案" tabindex="-1"><a class="header-anchor" href="#_5-time-wait状态与解决方案"><span>5. TIME_WAIT状态与解决方案</span></a></h2><h3 id="_5-1-什么是time-wait状态" tabindex="-1"><a class="header-anchor" href="#_5-1-什么是time-wait状态"><span>5.1 什么是TIME_WAIT状态</span></a></h3><p>TCP连接关闭时，主动关闭方会进入TIME_WAIT状态，并保持2MSL（Maximum Segment Lifetime，最大报文生存时间）的时间。这个状态有两个目的：</p><ol><li>确保最后一个ACK能够到达被动关闭方</li><li>确保老连接的延迟数据不会影响到新的连接</li></ol><p>但当Nginx作为反向代理处理大量短连接时，可能会产生大量TIME_WAIT状态的连接，占用系统资源。</p><h3 id="_5-2-如何查看time-wait连接数量" tabindex="-1"><a class="header-anchor" href="#_5-2-如何查看time-wait连接数量"><span>5.2 如何查看TIME_WAIT连接数量</span></a></h3><p>可以使用以下命令查看：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 查看各种状态的连接数量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">netstat</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 或者使用ss命令</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ss</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -ant</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;{++s[$1]} END {for(k in s) print k, s[k]}&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-解决nginx-time-wait过多的方法" tabindex="-1"><a class="header-anchor" href="#_5-3-解决nginx-time-wait过多的方法"><span>5.3 解决Nginx TIME_WAIT过多的方法</span></a></h3><h4 id="_5-3-1-内核参数调整" tabindex="-1"><a class="header-anchor" href="#_5-3-1-内核参数调整"><span>5.3.1 内核参数调整</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 启用TIME_WAIT状态socket的快速回收</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">net.ipv4.tcp_tw_recycle</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 在Linux 4.12以后已移除，不建议使用</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 启用TIME_WAIT状态socket的重新使用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">net.ipv4.tcp_tw_reuse</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 设置TIME_WAIT状态socket的最大数量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">net.ipv4.tcp_max_tw_buckets</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 262144</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-2-使用keepalive连接" tabindex="-1"><a class="header-anchor" href="#_5-3-2-使用keepalive连接"><span>5.3.2 使用keepalive连接</span></a></h4><p>对于HTTP连接，可以使用keepalive减少连接的创建和销毁：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 客户端keepalive</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    keepalive_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">65</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    keepalive_requests </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 上游服务器keepalive</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> backend </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.1:8080;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        keepalive </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 每个worker保持的空闲keepalive连接数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            proxy_http_version </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 使用HTTP/1.1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">Connection </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 清除Connection头以启用keepalive</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">http://backend;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于TCP代理，可以调整proxy_timeout参数：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> mysql_servers </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.1:3306;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3306</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10m</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 增加超时时间，减少连接断开频率</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">mysql_servers;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-3-使用多个nginx实例或负载均衡器" tabindex="-1"><a class="header-anchor" href="#_5-3-3-使用多个nginx实例或负载均衡器"><span>5.3.3 使用多个Nginx实例或负载均衡器</span></a></h4><p>当单个Nginx实例无法处理连接负载时，可以考虑：</p><ol><li>部署多个Nginx实例，通过DNS轮询或上层负载均衡分发流量</li><li>使用硬件负载均衡设备如F5分担连接压力</li></ol><h2 id="_6-实际应用场景" tabindex="-1"><a class="header-anchor" href="#_6-实际应用场景"><span>6. 实际应用场景</span></a></h2><h3 id="_6-1-mysql数据库负载均衡" tabindex="-1"><a class="header-anchor" href="#_6-1-mysql数据库负载均衡"><span>6.1 MySQL数据库负载均衡</span></a></h3><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> mysql_read </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 读库集群，使用最少连接策略</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        least_conn</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.101:3306 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">max_fails</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> fail_timeout=30s;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.102:3306 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">max_fails</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> fail_timeout=30s;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.103:3306 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">max_fails</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> fail_timeout=30s backup;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> mysql_write </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 写库，使用主备模式</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.100:3306 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">max_fails</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> fail_timeout=30s;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.101:3306 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">max_fails</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> fail_timeout=30s backup;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">13306</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 读库端口</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">mysql_read;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10m</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">23306</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 写库端口</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">mysql_write;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10m</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-redis集群负载均衡" tabindex="-1"><a class="header-anchor" href="#_6-2-redis集群负载均衡"><span>6.2 Redis集群负载均衡</span></a></h3><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> redis_cluster </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        hash </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">remote_addr</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> consistent;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.201:6379 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">max_fails</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> fail_timeout=30s;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.202:6379 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">max_fails</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> fail_timeout=30s;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 192.168.1.203:6379 </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">max_fails</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> fail_timeout=30s;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6379</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">redis_cluster;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3m</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-实现简单的tcp防火墙" tabindex="-1"><a class="header-anchor" href="#_6-3-实现简单的tcp防火墙"><span>6.3 实现简单的TCP防火墙</span></a></h3><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 定义允许访问的IP地址</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    geo </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">tcp_allowed_ips</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">        default</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        192.168.1.0/</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">24</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        10.10.10.0/</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">24</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3306</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        # 根据IP进行访问控制</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ($</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">tcp_allowed_ips</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">0) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 403</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 拒绝连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">backend;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-调试与故障排查" tabindex="-1"><a class="header-anchor" href="#_7-调试与故障排查"><span>7. 调试与故障排查</span></a></h2><h3 id="_7-1-日志配置" tabindex="-1"><a class="header-anchor" href="#_7-1-日志配置"><span>7.1 日志配置</span></a></h3><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 定义日志格式</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    log_format </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">tcp_basic </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">remote_addr</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> [$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">time_local</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">] &#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                         &#39;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">protocol</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">status</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">bytes_sent</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">bytes_received</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                         &#39;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">session_time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">                         </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    access_log </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/var/log/nginx/tcp_access.log tcp_basic;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    error_log </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/var/log/nginx/tcp_error.log;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">3306</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">mysql_backend;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-常见问题及解决方法" tabindex="-1"><a class="header-anchor" href="#_7-2-常见问题及解决方法"><span>7.2 常见问题及解决方法</span></a></h3><ol><li><p><strong>连接超时问题</strong></p><ul><li>检查网络是否通畅：<code>ping</code>、<code>telnet</code>测试</li><li>检查防火墙设置：确保端口开放</li><li>调整超时参数：增加<code>proxy_connect_timeout</code>值</li></ul></li><li><p><strong>连接数过多导致资源耗尽</strong></p><ul><li>增加系统文件描述符限制：<code>ulimit -n</code></li><li>调整Nginx工作进程数和连接数</li><li>启用连接复用和keepalive机制</li></ul></li><li><p><strong>负载不均衡</strong></p><ul><li>检查负载均衡算法是否合适</li><li>检查服务器权重设置</li><li>考虑使用更复杂的负载均衡策略</li></ul></li></ol><h2 id="_8-总结" tabindex="-1"><a class="header-anchor" href="#_8-总结"><span>8. 总结</span></a></h2><p>Nginx的TCP代理功能为我们提供了强大的TCP服务负载均衡和代理能力，适用于各种需要TCP协议支持的应用场景。通过合理配置和优化，Nginx可以高效处理大量TCP连接，同时解决TIME_WAIT状态过多的问题。</p><p>在实际应用中，应根据具体需求和服务特性选择合适的配置参数和优化策略，同时结合系统级优化，打造高性能、高可用的TCP代理服务。</p>`,61),t=[e];function h(k,p){return a(),s("div",null,t)}const c=i(l,[["render",h],["__file","nginx_tcp.html.vue"]]),g=JSON.parse('{"path":"/posts/operations/nginx_tcp.html","title":"nginx之tcp","lang":"zh-CN","frontmatter":{"title":"nginx之tcp","icon":"lightbulb","author":"Wang Shiyu","date":"2025-03-31T00:00:00.000Z","category":["nginx"],"tag":["nginx","网络"],"description":"这篇文章源于，如果 nginx timewait 过多怎么办？本文将从应用角度出发，穿插TCP原理，详细讲解Nginx的TCP相关知识。 1. 什么是TCP TCP（传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。在网络模型中，TCP位于传输层，主要负责在不可靠的网络环境中提供可靠的数据传输服务。 TCP的主要特点： 面向连接：通信...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/posts/operations/nginx_tcp.html"}],["meta",{"property":"og:site_name","content":"JavaPub"}],["meta",{"property":"og:title","content":"nginx之tcp"}],["meta",{"property":"og:description","content":"这篇文章源于，如果 nginx timewait 过多怎么办？本文将从应用角度出发，穿插TCP原理，详细讲解Nginx的TCP相关知识。 1. 什么是TCP TCP（传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。在网络模型中，TCP位于传输层，主要负责在不可靠的网络环境中提供可靠的数据传输服务。 TCP的主要特点： 面向连接：通信..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-03-31T08:07:59.000Z"}],["meta",{"property":"article:author","content":"Wang Shiyu"}],["meta",{"property":"article:tag","content":"nginx"}],["meta",{"property":"article:tag","content":"网络"}],["meta",{"property":"article:published_time","content":"2025-03-31T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-03-31T08:07:59.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"nginx之tcp\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-03-31T00:00:00.000Z\\",\\"dateModified\\":\\"2025-03-31T08:07:59.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Wang Shiyu\\"}]}"]]},"headers":[{"level":2,"title":"1. 什么是TCP","slug":"_1-什么是tcp","link":"#_1-什么是tcp","children":[]},{"level":2,"title":"2. Nginx对TCP的支持","slug":"_2-nginx对tcp的支持","link":"#_2-nginx对tcp的支持","children":[{"level":3,"title":"2.1 Nginx Stream模块的基本工作原理","slug":"_2-1-nginx-stream模块的基本工作原理","link":"#_2-1-nginx-stream模块的基本工作原理","children":[]}]},{"level":2,"title":"3. Nginx TCP代理的配置","slug":"_3-nginx-tcp代理的配置","link":"#_3-nginx-tcp代理的配置","children":[{"level":3,"title":"3.1 基本配置","slug":"_3-1-基本配置","link":"#_3-1-基本配置","children":[]},{"level":3,"title":"3.2 负载均衡策略","slug":"_3-2-负载均衡策略","link":"#_3-2-负载均衡策略","children":[]},{"level":3,"title":"3.3 高级配置选项","slug":"_3-3-高级配置选项","link":"#_3-3-高级配置选项","children":[]}]},{"level":2,"title":"4. Nginx TCP优化","slug":"_4-nginx-tcp优化","link":"#_4-nginx-tcp优化","children":[{"level":3,"title":"4.1 内核参数优化","slug":"_4-1-内核参数优化","link":"#_4-1-内核参数优化","children":[]},{"level":3,"title":"4.2 Nginx工作进程和连接优化","slug":"_4-2-nginx工作进程和连接优化","link":"#_4-2-nginx工作进程和连接优化","children":[]}]},{"level":2,"title":"5. TIME_WAIT状态与解决方案","slug":"_5-time-wait状态与解决方案","link":"#_5-time-wait状态与解决方案","children":[{"level":3,"title":"5.1 什么是TIME_WAIT状态","slug":"_5-1-什么是time-wait状态","link":"#_5-1-什么是time-wait状态","children":[]},{"level":3,"title":"5.2 如何查看TIME_WAIT连接数量","slug":"_5-2-如何查看time-wait连接数量","link":"#_5-2-如何查看time-wait连接数量","children":[]},{"level":3,"title":"5.3 解决Nginx TIME_WAIT过多的方法","slug":"_5-3-解决nginx-time-wait过多的方法","link":"#_5-3-解决nginx-time-wait过多的方法","children":[]}]},{"level":2,"title":"6. 实际应用场景","slug":"_6-实际应用场景","link":"#_6-实际应用场景","children":[{"level":3,"title":"6.1 MySQL数据库负载均衡","slug":"_6-1-mysql数据库负载均衡","link":"#_6-1-mysql数据库负载均衡","children":[]},{"level":3,"title":"6.2 Redis集群负载均衡","slug":"_6-2-redis集群负载均衡","link":"#_6-2-redis集群负载均衡","children":[]},{"level":3,"title":"6.3 实现简单的TCP防火墙","slug":"_6-3-实现简单的tcp防火墙","link":"#_6-3-实现简单的tcp防火墙","children":[]}]},{"level":2,"title":"7. 调试与故障排查","slug":"_7-调试与故障排查","link":"#_7-调试与故障排查","children":[{"level":3,"title":"7.1 日志配置","slug":"_7-1-日志配置","link":"#_7-1-日志配置","children":[]},{"level":3,"title":"7.2 常见问题及解决方法","slug":"_7-2-常见问题及解决方法","link":"#_7-2-常见问题及解决方法","children":[]}]},{"level":2,"title":"8. 总结","slug":"_8-总结","link":"#_8-总结","children":[]}],"git":{"createdTime":1743408479000,"updatedTime":1743408479000,"contributors":[{"name":"javapub","email":"iswangshiyu@foxmail.com","commits":1}]},"readingTime":{"minutes":6.56,"words":1969},"filePathRelative":"posts/operations/nginx_tcp.md","localizedDate":"2025年3月31日","excerpt":"<p>这篇文章源于，如果 nginx timewait 过多怎么办？本文将从应用角度出发，穿插TCP原理，详细讲解Nginx的TCP相关知识。</p>\\n<h2>1. 什么是TCP</h2>\\n<p>TCP（传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。在网络模型中，TCP位于传输层，主要负责在不可靠的网络环境中提供可靠的数据传输服务。</p>\\n<p>TCP的主要特点：</p>\\n<ul>\\n<li><strong>面向连接</strong>：通信前需要先建立连接（三次握手），通信结束后需要释放连接（四次挥手）</li>\\n<li><strong>可靠性</strong>：通过序列号、确认应答、重传等机制保证数据可靠传输</li>\\n<li><strong>流量控制</strong>：通过滑动窗口机制控制数据传输速率</li>\\n<li><strong>拥塞控制</strong>：通过各种算法（如慢启动、拥塞避免）防止网络拥塞</li>\\n</ul>","autoDesc":true}');export{c as comp,g as data};
